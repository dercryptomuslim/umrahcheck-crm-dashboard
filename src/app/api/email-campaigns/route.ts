import { NextRequest, NextResponse } from 'next/server';
import { Resend } from 'resend';

const resend = new Resend(
  process.env.RESEND_API_KEY || 're_GjayicTJ_96myT9YP6TKFs6w853hi7Kcv'
);

interface EmailCampaignRequest {
  campaign_type: 'welcome_back' | 'price_drop' | 'ramadan_special';
  recipients: number;
  segment?: 'umrah_2025' | 'hajj_2025' | 'all';
  test_email?: string;
  language?: 'de' | 'en' | 'fr' | 'es' | 'tr' | 'ar';
}

interface HotelOffer {
  name: string;
  city: string;
  tier: string;
  price: number;
  originalPrice: number;
  savings: number;
  halal_booking_url: string;
}

// Mock hotel data for email campaigns
const mockHotelOffers: HotelOffer[] = [
  {
    name: 'Swiss√¥tel Makkah',
    city: 'Makkah',
    tier: 'luxury',
    price: 299,
    originalPrice: 349,
    savings: 50,
    halal_booking_url:
      'https://halalbooking.com/hotels/swissotel-makkah?ref=umrahcheck'
  },
  {
    name: 'The Oberoi Madina',
    city: 'Medina',
    tier: 'luxury',
    price: 249,
    originalPrice: 289,
    savings: 40,
    halal_booking_url:
      'https://halalbooking.com/hotels/oberoi-madina?ref=umrahcheck'
  },
  {
    name: 'DoubleTree by Hilton Jabal Omar',
    city: 'Makkah',
    tier: 'premium',
    price: 179,
    originalPrice: 199,
    savings: 20,
    halal_booking_url:
      'https://halalbooking.com/hotels/doubletree-jabal-omar?ref=umrahcheck'
  }
];

function getEmailTemplate(
  campaign_type: string,
  hotelOffers: HotelOffer[],
  language: string = 'de'
) {
  const baseUrl = 'https://umrahcheck.de';

  // Multi-language templates - Complete internationalization support
  const templates = {
    // German (Deutsch) - Default
    de: {
      welcome_back: {
        subject:
          'üïå Willkommen zur√ºck! Exklusive Umrah-Hotel-Angebote nur f√ºr Sie',
        greeting: 'As-salamu alaikum,',
        title: 'Willkommen zur√ºck!',
        subtitle: 'Exklusive Hotel-Angebote f√ºr Ihre n√§chste Umrah-Reise',
        intro:
          'Wir haben Sie vermisst! Unser KI-System hat unglaubliche Hotel-Angebote gefunden, die perfekt f√ºr Ihre n√§chste Umrah-Reise sind. Diese Preise sind deutlich gefallen und werden nicht lange verf√ºgbar sein.',
        save: 'Sparen Sie',
        book_btn: 'Jetzt mit HalalBooking buchen',
        cta_title: '‚è∞ Zeitlich begrenztes Angebot',
        cta_text:
          'Diese Preise werden t√§glich von Live-Booking.com-Daten aktualisiert. Warten Sie nicht - sichern Sie sich heute Ihre Reservierung!',
        cta_btn: 'Alle Angebote ansehen',
        blessing:
          'M√∂ge Allah Ihre Umrah-Reise gesegnet und leicht machen. Ameen.',
        signature: 'Ihr UmrahCheck Team',
        unsubscribe: 'Abmelden',
        privacy: 'Datenschutz',
        contact: 'Kontakt'
      },
      price_drop: {
        subject:
          'üö® EILMELDUNG: Hotel-Preise um ‚Ç¨150 gefallen - Nur begrenzte Zeit!',
        title: 'üö® EILMELDUNG: PREISVERFALL',
        subtitle:
          'Handeln Sie schnell - Diese Angebote laufen in 48 Stunden ab!',
        countdown: '‚è∞ Nur noch 47 Stunden, 23 Minuten!',
        alert_title: 'Gro√üe Preissenkungen entdeckt:',
        intro:
          'Unser KI-√úberwachungssystem hat diese erheblichen Preissenkungen bei Top-Hotels in Makkah und Medina erkannt. Das sind die niedrigsten Preise, die wir dieses Jahr gesehen haben!',
        book_urgent: 'üî• JETZT BUCHEN - NUR BEGRENZTE ZEIT'
      },
      ramadan_special: {
        subject: 'üåô Ramadan Mubarak! Spezielle Umrah-Pakete - 30% Rabatt',
        title: 'üåô Ramadan Mubarak!',
        subtitle:
          'Spezielle Umrah-Pakete - 30% Rabatt in diesem gesegneten Monat',
        blessing_quote:
          '"Wer Umrah im Ramadan verrichtet, ist gleichwertig mit der Verrichtung von Hajj mit mir." - Prophet Muhammad (Friede sei mit ihm)',
        greeting: 'As-salamu alaikum und Ramadan Mubarak!',
        intro:
          'Dieser gesegnete Monat ist die perfekte Zeit, um Ihre spirituelle Reise zu planen. Wir bieten exklusive Rabatte auf Premium-Hotel-Pakete:',
        special_price: 'Spezial-Ramadan-Preis:',
        closing:
          'M√∂ge Allah Ihre Gebete annehmen und Ihnen eine gesegnete Umrah-Reise gew√§hren. Ameen.'
      }
    },

    // English
    en: {
      welcome_back: {
        subject: 'üïå Welcome Back! Exclusive Umrah Hotel Deals Just for You',
        greeting: 'As-salamu alaikum,',
        title: 'Welcome Back!',
        subtitle: 'Exclusive Hotel Deals for Your Next Umrah Journey',
        intro:
          "We've missed you! Our AI system has found incredible hotel deals that are perfect for your next Umrah journey. These prices have dropped significantly and won't be available for long.",
        save: 'Save',
        book_btn: 'Book Now with HalalBooking',
        cta_title: '‚è∞ Limited Time Offer',
        cta_text:
          "These prices are updated daily from live Booking.com data. Don't wait - secure your reservation today!",
        cta_btn: 'View All Deals',
        blessing: 'May Allah make your Umrah journey blessed and easy. Ameen.',
        signature: 'Your UmrahCheck Team',
        unsubscribe: 'Unsubscribe',
        privacy: 'Privacy',
        contact: 'Contact'
      },
      price_drop: {
        subject: 'üö® URGENT: Hotel Prices Dropped by ‚Ç¨150 - Limited Time!',
        title: 'üö® URGENT: PRICE DROP',
        subtitle: 'Act Fast - These Deals Expire in 48 Hours!',
        countdown: '‚è∞ Only 47 hours, 23 minutes left!',
        alert_title: 'Major Price Drops Detected:',
        intro:
          "Our AI monitoring system detected these significant price drops across top Makkah and Medina hotels. This is the lowest we've seen these prices all year!",
        book_urgent: 'üî• BOOK NOW - LIMITED TIME'
      },
      ramadan_special: {
        subject: 'üåô Ramadan Mubarak! Special Umrah Packages - 30% Off',
        title: 'üåô Ramadan Mubarak!',
        subtitle: 'Special Umrah Packages - 30% Off During This Blessed Month',
        blessing_quote:
          'Whoever performs Umrah in Ramadan, it is equivalent to performing Hajj with me. - Prophet Muhammad (Peace be upon him)',
        greeting: 'As-salamu alaikum and Ramadan Mubarak!',
        intro:
          "This blessed month is the perfect time to plan your spiritual journey. We're offering exclusive discounts on premium hotel packages:",
        special_price: 'Special Ramadan Price:',
        closing:
          'May Allah accept your prayers and grant you a blessed Umrah journey. Ameen.'
      }
    },

    // French (Fran√ßais)
    fr: {
      welcome_back: {
        subject:
          "üïå Bon retour ! Offres exclusives d'h√¥tels Umrah rien que pour vous",
        greeting: 'As-salamu alaikum,',
        title: 'Bon retour !',
        subtitle: "Offres d'h√¥tels exclusives pour votre prochain voyage Umrah",
        intro:
          "Vous nous avez manqu√© ! Notre syst√®me IA a trouv√© des offres d'h√¥tels incroyables parfaites pour votre prochain voyage Umrah. Ces prix ont consid√©rablement baiss√© et ne seront pas disponibles longtemps.",
        save: '√âconomisez',
        book_btn: 'R√©server maintenant avec HalalBooking',
        cta_title: '‚è∞ Offre √† dur√©e limit√©e',
        cta_text:
          "Ces prix sont mis √† jour quotidiennement √† partir des donn√©es en direct de Booking.com. N'attendez pas - s√©curisez votre r√©servation aujourd'hui !",
        cta_btn: 'Voir toutes les offres',
        blessing: "Qu'Allah rende votre voyage Umrah b√©ni et facile. Ameen.",
        signature: 'Votre √©quipe UmrahCheck',
        unsubscribe: 'Se d√©sabonner',
        privacy: 'Confidentialit√©',
        contact: 'Contact'
      },
      price_drop: {
        subject:
          'üö® URGENT : Les prix des h√¥tels ont chut√© de 150 ‚Ç¨ - Temps limit√© !',
        title: 'üö® URGENT : CHUTE DE PRIX',
        subtitle: 'Agissez vite - Ces offres expirent dans 48 heures !',
        countdown: '‚è∞ Plus que 47 heures, 23 minutes !',
        alert_title: 'Chutes de prix majeures d√©tect√©es :',
        intro:
          'Notre syst√®me de surveillance IA a d√©tect√© ces chutes de prix importantes dans les meilleurs h√¥tels de La Mecque et M√©dine. Ce sont les prix les plus bas que nous ayons vus cette ann√©e !',
        book_urgent: 'üî• R√âSERVER MAINTENANT - TEMPS LIMIT√â'
      },
      ramadan_special: {
        subject:
          'üåô Ramadan Mubarak ! Forfaits Umrah sp√©ciaux - 30% de r√©duction',
        title: 'üåô Ramadan Mubarak !',
        subtitle:
          'Forfaits Umrah sp√©ciaux - 30% de r√©duction pendant ce mois b√©ni',
        blessing_quote:
          "Celui qui accomplit la Umrah pendant le Ramadan, c'est √©quivalent √† accomplir le Hajj avec moi. - Proph√®te Muhammad (Paix soit sur lui)",
        greeting: 'As-salamu alaikum et Ramadan Mubarak !',
        intro:
          'Ce mois b√©ni est le moment parfait pour planifier votre voyage spirituel. Nous offrons des r√©ductions exclusives sur les forfaits h√¥teliers premium :',
        special_price: 'Prix sp√©cial Ramadan :',
        closing:
          "Qu'Allah accepte vos pri√®res et vous accorde un voyage Umrah b√©ni. Ameen."
      }
    },

    // Spanish (Espa√±ol)
    es: {
      welcome_back: {
        subject:
          'üïå ¬°Bienvenido de vuelta! Ofertas exclusivas de hoteles Umrah solo para ti',
        greeting: 'As-salamu alaikum,',
        title: '¬°Bienvenido de vuelta!',
        subtitle: 'Ofertas exclusivas de hoteles para tu pr√≥ximo viaje Umrah',
        intro:
          '¬°Te hemos echado de menos! Nuestro sistema de IA ha encontrado ofertas incre√≠bles de hoteles perfectas para tu pr√≥ximo viaje Umrah. Estos precios han bajado significativamente y no estar√°n disponibles por mucho tiempo.',
        save: 'Ahorra',
        book_btn: 'Reservar ahora con HalalBooking',
        cta_title: '‚è∞ Oferta por tiempo limitado',
        cta_text:
          'Estos precios se actualizan diariamente con datos en vivo de Booking.com. ¬°No esperes - asegura tu reserva hoy!',
        cta_btn: 'Ver todas las ofertas',
        blessing:
          'Que Allah haga que tu viaje Umrah sea bendecido y f√°cil. Ameen.',
        signature: 'Tu equipo UmrahCheck',
        unsubscribe: 'Darse de baja',
        privacy: 'Privacidad',
        contact: 'Contacto'
      },
      price_drop: {
        subject:
          'üö® URGENTE: Los precios de hoteles bajaron ‚Ç¨150 - ¬°Tiempo limitado!',
        title: 'üö® URGENTE: CA√çDA DE PRECIOS',
        subtitle: 'Act√∫a r√°pido - ¬°Estas ofertas expiran en 48 horas!',
        countdown: '‚è∞ ¬°Solo quedan 47 horas, 23 minutos!',
        alert_title: 'Ca√≠das importantes de precios detectadas:',
        intro:
          'Nuestro sistema de monitoreo IA detect√≥ estas ca√≠das significativas de precios en los mejores hoteles de La Meca y Medina. ¬°Estos son los precios m√°s bajos que hemos visto este a√±o!',
        book_urgent: 'üî• RESERVAR AHORA - TIEMPO LIMITADO'
      },
      ramadan_special: {
        subject:
          'üåô ¬°Ramad√°n Mubarak! Paquetes especiales Umrah - 30% de descuento',
        title: 'üåô ¬°Ramad√°n Mubarak!',
        subtitle:
          'Paquetes especiales Umrah - 30% de descuento durante este mes bendito',
        blessing_quote:
          'Quien realiza Umrah en Ramad√°n, es equivalente a realizar Hajj conmigo. - Profeta Muhammad (Paz sea con √©l)',
        greeting: '¬°As-salamu alaikum y Ramad√°n Mubarak!',
        intro:
          'Este mes bendito es el momento perfecto para planificar tu viaje espiritual. Ofrecemos descuentos exclusivos en paquetes de hoteles premium:',
        special_price: 'Precio especial Ramad√°n:',
        closing:
          'Que Allah acepte tus oraciones y te conceda un viaje Umrah bendito. Ameen.'
      }
    },

    // Turkish (T√ºrk√ße)
    tr: {
      welcome_back: {
        subject:
          'üïå Tekrar Ho≈ü Geldiniz! Sadece Sizin ƒ∞√ßin √ñzel Umre Otel Fƒ±rsatlarƒ±',
        greeting: 'Es-selamu aleykum,',
        title: 'Tekrar Ho≈ü Geldiniz!',
        subtitle: 'Bir Sonraki Umre Yolculuƒüunuz ƒ∞√ßin √ñzel Otel Fƒ±rsatlarƒ±',
        intro:
          'Sizi √∂zledik! AI sistemimiz bir sonraki Umre yolculuƒüunuz i√ßin m√ºkemmel olan inanƒ±lmaz otel fƒ±rsatlarƒ± buldu. Bu fiyatlar √∂nemli √∂l√ß√ºde d√º≈üt√º ve uzun s√ºre mevcut olmayacak.',
        save: 'Tasarruf Edin',
        book_btn: 'HalalBooking ile ≈ûimdi Rezervasyon Yapƒ±n',
        cta_title: '‚è∞ Sƒ±nƒ±rlƒ± S√ºreli Teklif',
        cta_text:
          'Bu fiyatlar Booking.com canlƒ± verilerinden g√ºnl√ºk olarak g√ºncellenir. Beklemeyin - rezervasyonunuzu bug√ºn g√ºvence altƒ±na alƒ±n!',
        cta_btn: 'T√ºm Fƒ±rsatlarƒ± G√∂r√ºnt√ºle',
        blessing: 'Allah Umre yolculuƒüunuzu m√ºbarek ve kolay kƒ±lsƒ±n. Amin.',
        signature: 'UmrahCheck Ekibiniz',
        unsubscribe: 'Abonelikten √áƒ±k',
        privacy: 'Gizlilik',
        contact: 'ƒ∞leti≈üim'
      },
      price_drop: {
        subject: 'üö® ACƒ∞L: Otel Fiyatlarƒ± 150‚Ç¨ D√º≈üt√º - Sƒ±nƒ±rlƒ± S√ºre!',
        title: 'üö® ACƒ∞L: Fƒ∞YAT D√ú≈û√ú≈û√ú',
        subtitle:
          'Hƒ±zlƒ± Hareket Edin - Bu Fƒ±rsatlar 48 Saat ƒ∞√ßinde Sona Eriyor!',
        countdown: '‚è∞ Sadece 47 saat, 23 dakika kaldƒ±!',
        alert_title: 'B√ºy√ºk Fiyat D√º≈ü√º≈üleri Tespit Edildi:',
        intro:
          "AI izleme sistemimiz Mekke ve Medine'deki en iyi otellerde bu √∂nemli fiyat d√º≈ü√º≈ülerini tespit etti. Bu yƒ±l g√∂rd√ºƒü√ºm√ºz en d√º≈ü√ºk fiyatlar!",
        book_urgent: 'üî• ≈ûƒ∞MDƒ∞ REZERVASYON YAPIN - SINIRLI S√úRE'
      },
      ramadan_special: {
        subject: 'üåô Ramazan M√ºbarek! √ñzel Umre Paketleri - %30 ƒ∞ndirim',
        title: 'üåô Ramazan M√ºbarek!',
        subtitle: '√ñzel Umre Paketleri - Bu M√ºbarek Ayda %30 ƒ∞ndirim',
        blessing_quote:
          "Kim Ramazan'da Umre yaparsa, benimle birlikte Hac yapmƒ±≈ü gibidir. - Peygamber Muhammad (s.a.v.)",
        greeting: 'Es-selamu aleykum ve Ramazan M√ºbarek!',
        intro:
          'Bu m√ºbarek ay ruhani yolculuƒüunuzu planlamanƒ±n m√ºkemmel zamanƒ±dƒ±r. Premium otel paketlerinde √∂zel indirimler sunuyoruz:',
        special_price: '√ñzel Ramazan Fiyatƒ±:',
        closing:
          'Allah dualarƒ±nƒ±zƒ± kabul etsin ve size m√ºbarek bir Umre yolculuƒüu nasip etsin. Amin.'
      }
    },

    // Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)
    ar: {
      welcome_back: {
        subject: 'üïå ÿ£ŸáŸÑÿßŸã ÿ®ÿπŸàÿØÿ™ŸÉ! ÿπÿ±Ÿàÿ∂ ŸÅŸÜÿßÿØŸÇ ÿ≠ÿµÿ±Ÿäÿ© ŸÑŸÑÿπŸÖÿ±ÿ© ÿÆÿßÿµÿ© ÿ®ŸÉ',
        greeting: 'ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿáÿå',
        title: 'ÿ£ŸáŸÑÿßŸã ÿ®ÿπŸàÿØÿ™ŸÉ!',
        subtitle: 'ÿπÿ±Ÿàÿ∂ ŸÅŸÜÿßÿØŸÇ ÿ≠ÿµÿ±Ÿäÿ© ŸÑÿ±ÿ≠ŸÑÿ© ÿßŸÑÿπŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©',
        intro:
          'ŸÑŸÇÿØ ÿßŸÅÿ™ŸÇÿØŸÜÿßŸÉ! ŸÑŸÇÿØ Ÿàÿ¨ÿØ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ŸÑÿØŸäŸÜÿß ÿπÿ±Ÿàÿ∂ ŸÅŸÜÿßÿØŸÇ ŸÖÿ∞ŸáŸÑÿ© ŸÖÿ´ÿßŸÑŸäÿ© ŸÑÿ±ÿ≠ŸÑÿ© ÿßŸÑÿπŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©. ÿßŸÜÿÆŸÅÿ∂ÿ™ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿ®ÿ¥ŸÉŸÑ ŸÉÿ®Ÿäÿ± ŸàŸÑŸÜ ÿ™ŸÉŸàŸÜ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÅÿ™ÿ±ÿ© ÿ∑ŸàŸäŸÑÿ©.',
        save: 'ŸàŸÅÿ±',
        book_btn: 'ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿ¢ŸÜ ŸÖÿπ HalalBooking',
        cta_title: '‚è∞ ÿπÿ±ÿ∂ ŸÑŸÅÿ™ÿ±ÿ© ŸÖÿ≠ÿØŸàÿØÿ©',
        cta_text:
          'Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ Ÿáÿ∞Ÿá ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿ®ŸäÿßŸÜÿßÿ™ Booking.com ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©. ŸÑÿß ÿ™ŸÜÿ™ÿ∏ÿ± - ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑŸäŸàŸÖ!',
        cta_btn: 'ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπÿ±Ÿàÿ∂',
        blessing: 'ÿßŸÑŸÑŸáŸÖ ÿ®ÿßÿ±ŸÉ ŸÅŸä ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿπŸÖÿ±ÿ© Ÿàÿßÿ¨ÿπŸÑŸáÿß ÿ≥ŸáŸÑÿ© ŸÖŸäÿ≥ÿ±ÿ©. ÿ¢ŸÖŸäŸÜ.',
        signature: 'ŸÅÿ±ŸäŸÇ UmrahCheck',
        unsubscribe: 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ',
        privacy: 'ÿßŸÑÿÆÿµŸàÿµŸäÿ©',
        contact: 'ÿßÿ™ÿµŸÑ ÿ®ŸÜÿß'
      },
      price_drop: {
        subject:
          'üö® ÿπÿßÿ¨ŸÑ: ÿßŸÜÿÆŸÅÿ∂ÿ™ ÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸÅŸÜÿßÿØŸÇ ÿ®ŸÖŸÇÿØÿßÿ± 150 ŸäŸàÿ±Ÿà - ŸÑŸÅÿ™ÿ±ÿ© ŸÖÿ≠ÿØŸàÿØÿ©!',
        title: 'üö® ÿπÿßÿ¨ŸÑ: ÿßŸÜÿÆŸÅÿßÿ∂ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±',
        subtitle: 'ÿ™ÿ≠ÿ±ŸÉ ÿ®ÿ≥ÿ±ÿπÿ© - ÿ™ŸÜÿ™ŸáŸä Ÿáÿ∞Ÿá ÿßŸÑÿπÿ±Ÿàÿ∂ ÿÆŸÑÿßŸÑ 48 ÿ≥ÿßÿπÿ©!',
        countdown: '‚è∞ ÿ®ÿßŸÇŸä 47 ÿ≥ÿßÿπÿ© Ÿà23 ÿØŸÇŸäŸÇÿ© ŸÅŸÇÿ∑!',
        alert_title: 'ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÜÿÆŸÅÿßÿ∂ÿßÿ™ ŸÉÿ®Ÿäÿ±ÿ© ŸÅŸä ÿßŸÑÿ£ÿ≥ÿπÿßÿ±:',
        intro:
          'ÿßŸÉÿ™ÿ¥ŸÅ ŸÜÿ∏ÿßŸÖ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä Ÿáÿ∞Ÿá ÿßŸÑÿßŸÜÿÆŸÅÿßÿ∂ÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© ŸÅŸä ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ŸÅŸä ÿ£ŸÅÿ∂ŸÑ ŸÅŸÜÿßÿØŸÇ ŸÖŸÉÿ© ŸàÿßŸÑŸÖÿØŸäŸÜÿ©. Ÿáÿ∞Ÿá ÿ£ŸÇŸÑ ÿßŸÑÿ£ÿ≥ÿπÿßÿ± ÿßŸÑÿ™Ÿä ÿ±ÿ£ŸäŸÜÿßŸáÿß Ÿáÿ∞ÿß ÿßŸÑÿπÿßŸÖ!',
        book_urgent: 'üî• ÿßÿ≠ÿ¨ÿ≤ ÿßŸÑÿ¢ŸÜ - ŸÑŸÅÿ™ÿ±ÿ© ŸÖÿ≠ÿØŸàÿØÿ©'
      },
      ramadan_special: {
        subject: 'üåô ÿ±ŸÖÿ∂ÿßŸÜ ŸÖÿ®ÿßÿ±ŸÉ! ÿ®ÿßŸÇÿßÿ™ ÿπŸÖÿ±ÿ© ÿÆÿßÿµÿ© - ÿÆÿµŸÖ 30%',
        title: 'üåô ÿ±ŸÖÿ∂ÿßŸÜ ŸÖÿ®ÿßÿ±ŸÉ!',
        subtitle: 'ÿ®ÿßŸÇÿßÿ™ ÿπŸÖÿ±ÿ© ÿÆÿßÿµÿ© - ÿÆÿµŸÖ 30% ÿÆŸÑÿßŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿ®ÿßÿ±ŸÉ',
        blessing_quote:
          'ŸÖŸÜ ÿ£ÿØŸâ ÿπŸÖÿ±ÿ© ŸÅŸä ÿ±ŸÖÿ∂ÿßŸÜ ŸÉÿßŸÜÿ™ ŸÉÿ≠ÿ¨ÿ© ŸÖÿπŸä. - ÿßŸÑŸÜÿ®Ÿä ŸÖÿ≠ŸÖÿØ ÿµŸÑŸâ ÿßŸÑŸÑŸá ÿπŸÑŸäŸá Ÿàÿ≥ŸÑŸÖ',
        greeting: 'ÿßŸÑÿ≥ŸÑÿßŸÖ ÿπŸÑŸäŸÉŸÖ Ÿàÿ±ÿ≠ŸÖÿ© ÿßŸÑŸÑŸá Ÿàÿ®ÿ±ŸÉÿßÿ™Ÿá Ÿàÿ±ŸÖÿ∂ÿßŸÜ ŸÖÿ®ÿßÿ±ŸÉ!',
        intro:
          'Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿ®ÿßÿ±ŸÉ ŸáŸà ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÖÿ´ÿßŸÑŸä ŸÑÿ™ÿÆÿ∑Ÿäÿ∑ ÿ±ÿ≠ŸÑÿ™ŸÉ ÿßŸÑÿ±Ÿàÿ≠ÿßŸÜŸäÿ©. ŸÜŸÇÿØŸÖ ÿÆÿµŸàŸÖÿßÿ™ ÿ≠ÿµÿ±Ÿäÿ© ÿπŸÑŸâ ÿ®ÿßŸÇÿßÿ™ ÿßŸÑŸÅŸÜÿßÿØŸÇ ÿßŸÑŸÖŸÖŸäÿ≤ÿ©:',
        special_price: 'ÿ≥ÿπÿ± ÿ±ŸÖÿ∂ÿßŸÜ ÿßŸÑÿÆÿßÿµ:',
        closing: 'ÿßŸÑŸÑŸáŸÖ ÿ™ŸÇÿ®ŸÑ ÿØÿπÿßÿ°ŸÉ Ÿàÿßÿ±ÿ≤ŸÇŸÉ ÿ±ÿ≠ŸÑÿ© ÿπŸÖÿ±ÿ© ŸÖÿ®ÿßÿ±ŸÉÿ©. ÿ¢ŸÖŸäŸÜ.'
      }
    }
  };

  const t = templates[language] || templates.de;

  switch (campaign_type) {
    case 'welcome_back':
      return {
        subject: t.welcome_back.subject,
        html: `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Willkommen zur√ºck bei UmrahCheck</title>
            <style>
              body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
              .container { max-width: 600px; margin: 0 auto; background: #ffffff; }
              .header { background: linear-gradient(135deg, #10b981, #059669); padding: 30px 20px; text-align: center; }
              .header h1 { color: white; margin: 0; font-size: 28px; }
              .header p { color: #d1fae5; margin: 10px 0 0 0; font-size: 16px; }
              .content { padding: 30px 20px; }
              .hotel-offer { border: 1px solid #e5e7eb; border-radius: 8px; margin: 20px 0; overflow: hidden; }
              .hotel-header { background: #f9fafb; padding: 15px 20px; border-bottom: 1px solid #e5e7eb; }
              .hotel-name { font-size: 18px; font-weight: bold; color: #111827; margin: 0; }
              .hotel-location { color: #6b7280; font-size: 14px; margin: 5px 0 0 0; }
              .hotel-details { padding: 20px; }
              .price-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
              .current-price { font-size: 24px; font-weight: bold; color: #10b981; }
              .original-price { text-decoration: line-through; color: #6b7280; font-size: 16px; margin-left: 10px; }
              .savings { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
              .book-btn { background: #10b981; color: white; text-decoration: none; padding: 12px 24px; border-radius: 6px; display: inline-block; font-weight: bold; }
              .book-btn:hover { background: #059669; }
              .footer { background: #f3f4f6; padding: 20px; text-align: center; color: #6b7280; font-size: 14px; }
              .cta-section { background: #fef3c7; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0; }
              .cta-title { color: #92400e; font-size: 20px; font-weight: bold; margin: 0 0 10px 0; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üïå ${t.welcome_back.title}</h1>
                <p>${t.welcome_back.subtitle}</p>
              </div>
              
              <div class="content">
                <h2>${t.welcome_back.greeting}</h2>
                <p>${t.welcome_back.intro}</p>
                
                ${hotelOffers
                  .map(
                    (hotel) => `
                  <div class="hotel-offer">
                    <div class="hotel-header">
                      <h3 class="hotel-name">${hotel.name}</h3>
                      <p class="hotel-location">üìç ${hotel.city} ‚Ä¢ ${hotel.tier.charAt(0).toUpperCase() + hotel.tier.slice(1)} Hotel</p>
                    </div>
                    <div class="hotel-details">
                      <div class="price-section">
                        <div>
                          <span class="current-price">‚Ç¨${hotel.price}</span>
                          <span class="original-price">‚Ç¨${hotel.originalPrice}</span>
                        </div>
                        <span class="savings">${t.welcome_back.save} ‚Ç¨${hotel.savings}</span>
                      </div>
                      <a href="${hotel.halal_booking_url}" class="book-btn">${t.welcome_back.book_btn}</a>
                    </div>
                  </div>
                `
                  )
                  .join('')}
                
                <div class="cta-section">
                  <h3 class="cta-title">${t.welcome_back.cta_title}</h3>
                  <p>${t.welcome_back.cta_text}</p>
                  <a href="${baseUrl}/hotels" class="book-btn">${t.welcome_back.cta_btn}</a>
                </div>
              </div>
              
              <div class="footer">
                <p>${t.welcome_back.blessing}</p>
                <p><strong>${t.welcome_back.signature}</strong></p>
                <p>
                  <a href="${baseUrl}/abmelden">${t.welcome_back.unsubscribe}</a> | 
                  <a href="${baseUrl}/datenschutz">${t.welcome_back.privacy}</a> | 
                  <a href="${baseUrl}/kontakt">${t.welcome_back.contact}</a>
                </p>
              </div>
            </div>
          </body>
          </html>
        `
      };

    case 'price_drop':
      return {
        subject: t.price_drop.subject,
        html: `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.price_drop.title}</title>
            <style>
              body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: #f8fafc; color: #333; }
              .container { max-width: 600px; margin: 0 auto; background: white; }
              .urgent-header { background: #dc2626; color: white; padding: 30px 20px; text-align: center; }
              .urgent-header h1 { margin: 0; font-size: 28px; font-weight: bold; }
              .urgent-header p { margin: 10px 0 0 0; font-size: 16px; color: #fecaca; }
              .content { padding: 30px 20px; }
              .countdown { background: #fbbf24; color: #92400e; padding: 15px; text-align: center; font-weight: bold; border-radius: 8px; font-size: 18px; margin: 20px 0; }
              .price-alert { background: #fef2f2; border-left: 4px solid #dc2626; padding: 20px; margin: 20px 0; border-radius: 4px; }
              .price-alert h3 { margin-top: 0; color: #dc2626; font-size: 20px; }
              .hotel-deal { background: white; border: 2px solid #dc2626; margin: 15px 0; padding: 20px; border-radius: 8px; }
              .hotel-deal h4 { margin: 0 0 10px 0; font-size: 18px; color: #111827; }
              .price-comparison { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
              .old-price { text-decoration: line-through; color: #6b7280; font-size: 16px; }
              .new-price { font-size: 24px; font-weight: bold; color: #dc2626; }
              .savings-badge { background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 4px; font-size: 14px; font-weight: bold; }
              .urgent-btn { background: #dc2626; color: white; text-decoration: none; padding: 15px 30px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 18px; margin: 20px 0; }
              .urgent-btn:hover { background: #b91c1c; }
              .footer { background: #f3f4f6; padding: 20px; text-align: center; color: #6b7280; font-size: 14px; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="urgent-header">
                <h1>${t.price_drop.title}</h1>
                <p>${t.price_drop.subtitle}</p>
              </div>
              
              <div class="content">
                <div class="countdown">${t.price_drop.countdown}</div>
                
                <div class="price-alert">
                  <h3>${t.price_drop.alert_title}</h3>
                  <p>${t.price_drop.intro}</p>
                  
                  ${hotelOffers
                    .map(
                      (hotel) => `
                    <div class="hotel-deal">
                      <h4>${hotel.name} - ${hotel.city}</h4>
                      <div class="price-comparison">
                        <span class="old-price">‚Ç¨${hotel.originalPrice}</span>
                        <span>‚Üí</span>
                        <span class="new-price">‚Ç¨${hotel.price}</span>
                        <span class="savings-badge">${t.welcome_back.save} ‚Ç¨${hotel.savings}</span>
                      </div>
                      <a href="${hotel.halal_booking_url}" class="urgent-btn">${t.price_drop.book_urgent}</a>
                    </div>
                  `
                    )
                    .join('')}
                </div>
                
                <div style="text-align: center; margin: 30px 0;">
                  <a href="${baseUrl}/hotels" class="urgent-btn">${t.price_drop.book_urgent}</a>
                </div>
              </div>
              
              <div class="footer">
                <p>${t.welcome_back.blessing}</p>
                <p><strong>${t.welcome_back.signature}</strong></p>
                <p>
                  <a href="${baseUrl}/abmelden">${t.welcome_back.unsubscribe}</a> | 
                  <a href="${baseUrl}/datenschutz">${t.welcome_back.privacy}</a> | 
                  <a href="${baseUrl}/kontakt">${t.welcome_back.contact}</a>
                </p>
              </div>
            </div>
          </body>
          </html>
        `
      };

    case 'ramadan_special':
      return {
        subject: t.ramadan_special.subject,
        html: `
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${t.ramadan_special.title}</title>
            <style>
              body { font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
              .container { max-width: 600px; margin: 0 auto; background: #ffffff; }
              .ramadan-header { background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white; padding: 40px 20px; text-align: center; }
              .ramadan-header h1 { margin: 0; font-size: 32px; font-weight: bold; }
              .ramadan-header p { margin: 15px 0 0 0; font-size: 18px; color: #e9d5ff; }
              .content { padding: 30px 20px; }
              .blessing { background: #faf5ff; border: 2px solid #a855f7; padding: 25px; border-radius: 12px; text-align: center; font-style: italic; margin: 25px 0; color: #581c87; font-size: 16px; line-height: 1.8; }
              .hotel-offer { border: 2px solid #a855f7; border-radius: 12px; margin: 20px 0; overflow: hidden; background: linear-gradient(to right, #faf5ff, #ffffff); }
              .hotel-header { background: #f3e8ff; padding: 20px; border-bottom: 1px solid #e9d5ff; }
              .hotel-name { font-size: 20px; font-weight: bold; color: #581c87; margin: 0; }
              .hotel-location { color: #7c3aed; font-size: 14px; margin: 5px 0 0 0; font-weight: 500; }
              .hotel-details { padding: 25px; }
              .price-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
              .special-price-label { font-size: 14px; color: #7c3aed; font-weight: 600; margin-bottom: 5px; }
              .current-price { font-size: 26px; font-weight: bold; color: #7c3aed; }
              .original-price { text-decoration: line-through; color: #9ca3af; font-size: 18px; margin-left: 12px; }
              .ramadan-discount { background: #dcfce7; color: #166534; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: bold; }
              .book-btn { background: linear-gradient(135deg, #7c3aed, #5b21b6); color: white; text-decoration: none; padding: 14px 28px; border-radius: 8px; display: inline-block; font-weight: bold; font-size: 16px; transition: all 0.3s; }
              .book-btn:hover { background: linear-gradient(135deg, #6d28d9, #4c1d95); transform: translateY(-1px); }
              .footer { background: #f8fafc; padding: 25px; text-align: center; color: #6b7280; font-size: 14px; }
              .closing-blessing { background: #fef3c7; color: #92400e; padding: 20px; border-radius: 8px; text-align: center; margin: 25px 0; font-weight: 500; }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="ramadan-header">
                <h1>${t.ramadan_special.title}</h1>
                <p>${t.ramadan_special.subtitle}</p>
              </div>
              
              <div class="content">
                <div class="blessing">
                  "${t.ramadan_special.blessing_quote}"
                </div>
                
                <h2>${t.ramadan_special.greeting}</h2>
                <p>${t.ramadan_special.intro}</p>
                
                ${hotelOffers
                  .map(
                    (hotel) => `
                  <div class="hotel-offer">
                    <div class="hotel-header">
                      <h3 class="hotel-name">${hotel.name}</h3>
                      <p class="hotel-location">üìç ${hotel.city} ‚Ä¢ Ramadan Spezial-Paket</p>
                    </div>
                    <div class="hotel-details">
                      <div class="special-price-label">${t.ramadan_special.special_price}</div>
                      <div class="price-section">
                        <div>
                          <span class="current-price">‚Ç¨${hotel.price}</span>
                          <span class="original-price">‚Ç¨${hotel.originalPrice}</span>
                        </div>
                        <span class="ramadan-discount">30% Ramadan-Rabatt</span>
                      </div>
                      <a href="${hotel.halal_booking_url}" class="book-btn">üåô Jetzt buchen - Ramadan Special</a>
                    </div>
                  </div>
                `
                  )
                  .join('')}
                
                <div class="closing-blessing">
                  ${t.ramadan_special.closing}
                </div>
              </div>
              
              <div class="footer">
                <p><strong>${t.welcome_back.signature}</strong></p>
                <p>
                  <a href="${baseUrl}/abmelden">${t.welcome_back.unsubscribe}</a> | 
                  <a href="${baseUrl}/datenschutz">${t.welcome_back.privacy}</a> | 
                  <a href="${baseUrl}/kontakt">${t.welcome_back.contact}</a>
                </p>
              </div>
            </div>
          </body>
          </html>
        `
      };

    default:
      return {
        subject: 'UmrahCheck Hotel Updates',
        html: '<p>Default email template</p>'
      };
  }
}

export async function POST(request: NextRequest) {
  const startTime = Date.now();

  try {
    const body: EmailCampaignRequest = await request.json();
    const {
      campaign_type,
      recipients,
      segment = 'all',
      test_email,
      language = 'de'
    } = body;

    // Validation
    if (!campaign_type || !recipients) {
      return NextResponse.json(
        {
          success: false,
          message: 'Missing required fields: campaign_type, recipients'
        },
        { status: 400 }
      );
    }

    console.log(
      `üìß Starting ${campaign_type} campaign for ${recipients} contacts`
    );

    // Fetch live hotel prices (in production, this would be from database)
    console.log('üîç Fetching live hotel prices for email personalization...');

    // Simulate fetching hotel data
    await new Promise((resolve) => setTimeout(resolve, 200));
    const hotelOffers = mockHotelOffers.slice(0, 3); // Get top 3 deals

    // For now, use mock affiliate URLs until HalalBooking partnership is ready
    const hotelOffersWithAffiliates = hotelOffers.map((hotel) => ({
      ...hotel,
      halal_booking_url: `${hotel.halal_booking_url}?ref=umrahcheck_de&utm_source=umrahcheck&utm_medium=email&tracking_id=uc_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    }));

    // Generate email template with language support
    const emailTemplate = getEmailTemplate(
      campaign_type,
      hotelOffersWithAffiliates,
      language
    );

    // Determine recipients (in production, query from database based on segment)
    const emailList = test_email
      ? [test_email]
      : [
          'mustafa19musse@hotmail.de', // Use the provided test email
          'test1@example.com',
          'test2@example.com',
          'test3@example.com',
          'test4@example.com'
        ].slice(0, Math.min(recipients, 5)); // Limit for testing

    // Send emails in batches
    const batchSize = 5;
    const batches = [];

    for (let i = 0; i < emailList.length; i += batchSize) {
      batches.push(emailList.slice(i, i + batchSize));
    }

    console.log(
      `üì§ Sending ${emailList.length} emails in ${batches.length} batches`
    );

    let totalSent = 0;
    let totalFailed = 0;

    for (let i = 0; i < batches.length; i++) {
      const batch = batches[i];
      console.log(
        `üìß Sending batch ${i + 1}/${batches.length} (${batch.length} emails)`
      );

      try {
        // Send batch using Resend
        const emailPromises = batch.map((email) =>
          resend.emails.send({
            from: 'UmrahCheck <noreply@umrahcheck.de>',
            to: [email],
            subject: emailTemplate.subject,
            html: emailTemplate.html
          })
        );

        const results = await Promise.allSettled(emailPromises);

        const batchSent = results.filter(
          (r) => r.status === 'fulfilled'
        ).length;
        const batchFailed = results.filter(
          (r) => r.status === 'rejected'
        ).length;

        totalSent += batchSent;
        totalFailed += batchFailed;

        console.log(`‚úÖ Batch ${i + 1} sent successfully: ${batchSent} emails`);

        // Small delay between batches to respect rate limits
        if (i < batches.length - 1) {
          await new Promise((resolve) => setTimeout(resolve, 100));
        }
      } catch (error) {
        console.error(`‚ùå Error sending batch ${i + 1}:`, error);
        totalFailed += batch.length;
      }
    }

    const processingTime = Date.now() - startTime;

    console.log(
      `üéØ Campaign complete: ${totalSent} sent, ${totalFailed} failed in ${processingTime}ms`
    );

    return NextResponse.json({
      success: true,
      campaign_id: `campaign_${Date.now()}`,
      campaign_type,
      segment,
      total_recipients: emailList.length,
      emails_sent: totalSent,
      emails_failed: totalFailed,
      processing_time_ms: processingTime,
      hotel_offers_included: hotelOffers.length,
      message: `Successfully sent ${totalSent} emails for ${campaign_type} campaign`
    });
  } catch (error) {
    console.error('‚ùå Email campaign API error:', error);
    return NextResponse.json(
      {
        success: false,
        message: 'Internal server error during email campaign'
      },
      { status: 500 }
    );
  }
}

// GET method for testing
export async function GET(request: NextRequest) {
  return NextResponse.json({
    message: 'UmrahCheck Email Campaigns API',
    endpoint: 'POST /api/email-campaigns',
    version: '1.0.0',
    available_campaigns: ['welcome_back', 'price_drop', 'ramadan_special'],
    status: 'operational'
  });
}
